<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Private Key Encryption</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.0.7/html5-qrcode.min.js"></script>
    <style>
        /* Basic styles */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
        }

        .wrapper {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .panel {
            flex: 0 0 48%;
            box-sizing: border-box;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #fff;
            margin-bottom: 20px;
        }

        textarea,
        input {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
            padding-right: 15px;
        }

        button {
            background: #007bff;
            color: #fff;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        button:hover:not(:disabled) {
            background: #0056b3;
        }

        .copy-btn,
        .download-btn {
            margin-top: 10px;
            background: #28a745;
        }

        .status {
            color: green;
            font-size: 14px;
            margin-top: 10px;
        }

        .status.error {
            color: red;
        }

        #qrcode,
        #reader {
            text-align: center;
            margin: 20px 0;
        }

        .password-strength {
            font-size: 12px;
            margin-top: -10px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <script>
        // Function to get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Function to populate encrypted payload from URL parameter
        window.onload = function() {
            const payload = getUrlParameter('payload');
            if (payload) {
                document.getElementById('encryptedPayload').value = payload;
            }
        };
    </script>
    <h1>Secure Private Key Operations</h1>
    <div class="wrapper">
        <div class="panel">
            <h2>Encrypt Private Key</h2>
            <textarea id="privateKey" placeholder="Enter your private key" rows="4"></textarea>
            <input type="password" id="encryptPassword" placeholder="Enter a strong password">
            <p id="passwordStrength" class="password-strength"></p>
            <button onclick="encryptPrivateKey()">Encrypt</button>
            <p id="encryptStatus" class="status"></p>
            <textarea id="encryptedOutput" readonly rows="4"
                placeholder="Encrypted payload will appear here"></textarea>
            <div id="qrcode"></div>
            <button class="copy-btn" onclick="copyToClipboard('encryptedOutput')">Copy Encrypted Payload</button>
            <button class="download-btn" onclick="downloadQRCode()">Download QR Code</button>
        </div>
        <div class="panel">
            <h2>Decrypt Private Key</h2>
            <textarea id="encryptedPayload" placeholder="Paste your encrypted payload here" rows="4"></textarea>
            <input type="password" id="decryptPassword" placeholder="Enter your password">
            <button onclick="decryptPrivateKey()">Decrypt</button>
            <p id="decryptStatus" class="status"></p>
            <textarea id="decryptedOutput" readonly rows="4"
                placeholder="Decrypted private key will appear here"></textarea>
            <div id="reader"></div>
            <button onclick="scanQRCode()">Scan QR Code</button>
        </div>
    </div>
    <script>
        document.getElementById('encryptPassword').addEventListener('input', updatePasswordStrength);

        function updatePasswordStrength() {
            const strengthText = document.getElementById('passwordStrength');
            const password = document.getElementById('encryptPassword').value;
            const strength = calculatePasswordStrength(password);
            strengthText.textContent = `Password Strength: ${strength}`;
        }

        function calculatePasswordStrength(password) {
            let score = 0;
            if (password.length >= 8) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[!@#\$%\^&\*\(\)_\+\-=\[\]\{\};':"\\|,.<>\/?]+/.test(password)) score++;
            switch (score) {
                case 0:
                case 1: return "Weak";
                case 2: return "Moderate";
                case 3: return "Strong";
                case 4: return "Very Strong";
            }
        }

        function copyToClipboard(elementId) {
            const textarea = document.getElementById(elementId);
            textarea.select();
            document.execCommand('copy');
            alert('Ciphertext copied to clipboard!');
        }

        function encryptPrivateKey() {
            const privateKey = document.getElementById("privateKey").value.trim();
            const password = document.getElementById("encryptPassword").value.trim();
            const status = document.getElementById("encryptStatus");
            const output = document.getElementById("encryptedOutput");
            const qrContainer = document.getElementById("qrcode");
            if (!privateKey || !password) {
                status.textContent = "Private key and password are required.";
                status.className = "status error";
                return;
            }
            try {
                const salt = CryptoJS.lib.WordArray.random(128 / 8); // 16 bytes
                const iv = CryptoJS.lib.WordArray.random(128 / 8); // 16 bytes
                const key = CryptoJS.PBKDF2(password, salt, { keySize: 256 / 32, iterations: 100000 });
                const encrypted = CryptoJS.AES.encrypt(privateKey, key, { iv: iv }).toString();
                const payload = JSON.stringify({
                    ciphertext: encrypted,
                    salt: salt.toString(CryptoJS.enc.Hex),
                    iv: iv.toString(CryptoJS.enc.Hex)
                });
                output.value = payload;
                status.textContent = "Private key encrypted successfully!";
                status.className = "status";
                // Generate QR Code
                qrContainer.innerHTML = "";
                const qrCode = new QRCode(qrContainer, {
                    text: payload,
                    width: 128,
                    height: 128,
                });
            } catch (error) {
                status.textContent = "Error during encryption: " + error.message;
                status.className = "status error";
            }
        }

        function downloadQRCode() {
            const qrContainer = document.getElementById("qrcode").getElementsByTagName("img")[0];
            if (!qrContainer) {
                alert('Please generate a QR code first.');
                return;
            }
            const imgURL = qrContainer.src;
            const link = document.createElement('a');
            link.href = imgURL;
            link.download = 'encrypted_payload_qrcode.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function decryptPrivateKey() {
            const encryptedPayload = document.getElementById("encryptedPayload").value.trim();
            const password = document.getElementById("decryptPassword").value.trim();
            const status = document.getElementById("decryptStatus");
            const output = document.getElementById("decryptedOutput");
            if (!encryptedPayload || !password) {
                status.textContent = "Encrypted payload and password are required.";
                status.className = "status error";
                return;
            }
            try {
                const { ciphertext, salt, iv } = JSON.parse(encryptedPayload);
                const saltWordArray = CryptoJS.enc.Hex.parse(salt);
                const ivWordArray = CryptoJS.enc.Hex.parse(iv);
                const key = CryptoJS.PBKDF2(password, saltWordArray, { keySize: 256 / 32, iterations: 100000 });
                const decrypted = CryptoJS.AES.decrypt(ciphertext, key, { iv: ivWordArray });
                const privateKey = decrypted.toString(CryptoJS.enc.Utf8);
                if (!privateKey) throw new Error("Invalid password or corrupted data.");
                output.value = privateKey;
                status.textContent = "Private key decrypted successfully!";
                status.className = "status";
            } catch (error) {
                status.textContent = "Error during decryption: " + error.message;
                status.className = "status error";
            }
        }

        function scanQRCode() {
            const reader = document.getElementById("reader");
            reader.innerHTML = ''; // Clear previous content
            
            // Check if the device has a camera
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                reader.innerHTML = '<p style="color: red;">Camera access is not available on this device. Please use a mobile device with a camera to scan QR codes.</p>';
                return;
            }

            const html5QrCode = new Html5Qrcode("reader");
            
            // First check if we can access the camera
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(() => {
                    html5QrCode.start(
                        { facingMode: "environment" },
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        qrCodeMessage => {
                            document.getElementById("encryptedPayload").value = qrCodeMessage;
                            html5QrCode.stop();
                            reader.innerHTML = '<p style="color: green;">QR code scanned successfully!</p>';
                        },
                        () => {} // Empty error handler as we don't need to show scanning errors
                    )
                    .catch(err => {
                        console.error("QR Code scanner error:", err);
                        reader.innerHTML = '<p style="color: red;">Error starting QR code scanner. Please ensure camera permissions are granted.</p>';
                    });
                })
                .catch(err => {
                    console.error("Camera access error:", err);
                    reader.innerHTML = '<p style="color: red;">Unable to access camera. Please ensure camera permissions are granted and you\'re using HTTPS or localhost.</p>';
                });
        }
    </script>
</body>

</html>
